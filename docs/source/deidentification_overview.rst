Deidentification Overview
=========================

DICOM data is deidentified in the application using the following steps:

All files in the designated folder are read one by one using Pydicom. We read the following tag information:

#. Patient Name
#. Patient ID
#. Patient Birth Date
#. Study description
#. Study Instance UID
#. Series Instance UID
#. Frame of Reference UID
#. All SOP Instance UIDs
#. Study Date
#. Series Date

These are stored in the database for later use and data replacement. If the entry for the patient is available then the code checks if the Study, Series and Instance information is also available in the database. If it is avaialble then these data are not replaced. If they do not exist, the the data will be created. For each of these tage the code will generate a new value. 

The patient ID is generated using the the following method:

#. We get the current date and time.
#. We generate a new 6 digit random number. 
#. The unique ID is a combination of the current year, month, day, hour, minute, second, microsecond and the random number.


.. note::

   UIDs generated by DICOM are supposed to be globally unique.This assumption is used in the code. If the two patients have the same UUID then the code will not be able to identify the correct data to replace.   
..

Date processing is handled by the following method:

#. We get the date object from the DICOM file. 
#. We generate a random date offset between -60 and +60 days and add it to the original date whilst ensuring that this remains a valid date.
#. The actual date is replaced by the offset value.

.. note::

   The code only processes dicom modalities: CT, MR, and PET. Other modalities are not processed. Except for the automatic segmentation template other files in the folder will be discarded during the deidentification process.
..

After the database entries have been created, the code will replace the data in the DICOM files. The code will replace the following data:

#. Media Storage SOP Instance UID : 
#. SOP Instance UID
#. Study Instance UID
#. Series Instance UID
#. Frame of Reference UID
#. Patient Birth Date
#. Study Date
#. Series Date
#. Instance Creation Date
#. Acquisition Date
#. Content Date
#. Patient ID
#. Referring Physician Name
#. Study Description
#. Series Description

After this all private tags in the DICOM files are also removed. 

.. note::

   The code does not modify the pixel data in the file as it is important for accurate segmentation and radiotherapy planning.
..

The new dicom file is saved before it is exported to the remote server in a different directory. The old files are deleted after the deidentification process is complete.

Note the process ensures that even if the same DICOM series is processed multiple times, the data will be deidentified each time allowing the same series to be segmented multiple times.










