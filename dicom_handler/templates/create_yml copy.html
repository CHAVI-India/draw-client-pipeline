{% extends 'index.html' %}
{% load static %}
{% block content %}
<!-- Form -->
<form class="form">
    {% csrf_token %}
    <div class="form-group">
        <label for="templatename">DRAW Template Name</label>
        <input type="text" class="form-control" id="templatename" placeholder="Enter DRAW Template Name" required>
    </div>
    <div class="form-group">
        <label for="description">DRAW Template Description</label>
        <input type="text" class="form-control" id="description" placeholder="Enter DRAW Template Description" required>
    </div>
    <p>Select the models you want to include in the DRAW template</p>
    <!-- Table with DataTable Pagination -->
    <div class="table-container">
        <table id="mapinfo-table" class="table table-striped table-bordered">
            <thead>
                <tr>
                    <th>#</th>
                    <th>Model Id</th>
                    <th>Model Name</th>
                    <th>Map ID</th>
                    <th>Structure Name</th>
                    <th>Config</th>
                    <th>Trainer Name</th>
                    <th>Postprocess</th>
                    <th>View Details</th>
                </tr>
            </thead>
            <tbody>
                {% for info in apidata %}
                {% for map in info.modelmap %}
                <tr>
                    <td><input type="checkbox" class="model-checkbox" aria-label="Checkbox for following text input">
                    </td>
                    <td>{{ info.model_id }}</td>
                    <td>{{ info.model_name }}</td>
                    <td>{{ map.mapid }}</td>
                    <td>{{ map.map_tg263_primary_name }}</td>
                    <td>{{ info.model_config }}</td>
                    <td>{{ info.model_trainer_name }}</td>
                    <td>{{ info.model_postprocess }}</td>
                    <td><a href="{{ api_url }}/{{ map.id }}" target="_blank">View Details</a></td>
                </tr>
                {% endfor %}
                {% endfor %}
            </tbody>
        </table>
    </div>
    <button type="submit" class="btn btn-primary">Submit</button>
</form>

<!-- Include jQuery and DataTables -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.11.5/css/jquery.dataTables.css">

<script type="text/javascript">
    // Wait for document to be ready
    document.addEventListener('DOMContentLoaded', function () {
        $.fn.dataTable.ext.errMode = 'none';

        // Initialize DataTable
        let table = $('#mapinfo-table').DataTable({
            "paging": true,
            "searching": true,
            "lengthChange": true,
            "ordering": true
        });

        // Form submission
        $('.form').on('submit', function (event) {
            event.preventDefault();

            // Validate form
            if (!$('#templatename').val()) {
                alert('Please enter a template name');
                return false;
            }

            if (!$('#description').val()) {
                alert('Please enter a description');
                return false;
            }

            var selectedModels = [];
            table.$('input[type="checkbox"]:checked').each(function () {
                var row = $(this).closest('tr');
                var modelData = {
                    model_id: row.find('td:eq(1)').text().trim(),
                    model_name: row.find('td:eq(2)').text().trim(),
                    mapid: row.find('td:eq(3)').text().trim(),
                    map_tg263_primary_name: row.find('td:eq(4)').text().trim(),
                    model_config: row.find('td:eq(5)').text().trim(),
                    model_trainer_name: row.find('td:eq(6)').text().trim(),
                    model_postprocess: row.find('td:eq(7)').text().trim()
                };
                selectedModels.push(modelData);
            });

            var formData = {
                template_name: $('#templatename').val(),
                description: $('#description').val(),
                selected_models: selectedModels
            };

            console.log("Form Data", formData);

            // Send AJAX request
            $.ajax({
                type: 'POST',
                url: '{% url "create-yml" %}',
                data: JSON.stringify({
                    template_name: $('#templatename').val(),
                    description: $('#description').val(),
                    selected_models: selectedModels
                }),
                contentType: 'application/json charset=utf-8',
                headers: {
                    'X-CSRFToken': $('input[name="csrfmiddlewaretoken"]').val()
                },
                success: function (response) {
                    if (response.status === 'success' && response.redirect_url) {
                        window.location.href = response.redirect_url;
                    }
                },
                error: function (xhr, status, error) {
                    // Remove alert and just log to console
                    console.error("Error:", xhr.responseText);
                }
            });
        });
    });
</script>

<style>
    .table-container {
        margin: 20px 0;
        width: 100%;
        overflow-x: auto;
    }

    .form-group {
        margin-bottom: 15px;
    }
</style>
{% endblock content %}