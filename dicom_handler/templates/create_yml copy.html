{% extends 'index.html' %}
{% load static %}
{% block content %}

<div id="name-error" class="alert alert-danger" style="display:none;">
    This YAML name already exists. Please choose a different name.
</div>

<!-- Form -->
<form class="form">
    {% csrf_token %}
    <div class="form-group">
        <label for="templatename">DRAW Template Name</label>
        <input type="text" class="form-control" id="templatename" placeholder="Enter DRAW Template Name" required>
    </div>
    <div class="form-group">
        <label for="description">DRAW Template Description</label>
        <input type="text" class="form-control" id="description" placeholder="Enter DRAW Template Description" required>
    </div>
    <p>Select the models you want to include in the DRAW template</p>
    <!-- Table with DataTable Pagination -->
    <div class="table-container">
        <table id="mapinfo-table" class="table table-striped table-bordered">
            <thead>
                <tr>
                    <th>#</th>
                    <th>Model Id</th>
                    <th>Model Name</th>
                    <th>Map ID</th>
                    <th>Structure Name</th>
                    <th>Config</th>
                    <th>Trainer Name</th>
                    <th>Postprocess</th>
                    <th>View Details</th>
                </tr>
            </thead>
            <tbody>
                {% for info in apidata %}
                {% for map in info.modelmap %}
                <tr>
                    <td><input type="checkbox" class="model-checkbox" aria-label="Checkbox for following text input">
                    </td>
                    <td>{{ info.model_id }}</td>
                    <td>{{ info.model_name }}</td>
                    <td>{{ map.mapid }}</td>
                    <td>{{ map.map_tg263_primary_name }}</td>
                    <td>{{ info.model_config }}</td>
                    <td>{{ info.model_trainer_name }}</td>
                    <td>{{ info.model_postprocess }}</td>
                    <td><a href="{{ api_url }}/{{ map.id }}" target="_blank">View Details</a></td>
                </tr>
                {% endfor %}
                {% endfor %}
            </tbody>
        </table>
    </div>
    <button type="submit" class="btn btn-primary">Submit</button>
</form>

<!-- Include jQuery and DataTables -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.11.5/css/jquery.dataTables.css">

<script type="text/javascript">
    document.addEventListener('DOMContentLoaded', function () {
        let nameValidationTimeout;
        const templateNameInput = document.getElementById('templatename');
        const submitButton = document.querySelector('button[type="submit"]');
        
        // Function to validate yaml name
        function validateYamlName(yamlName) {
            if (!yamlName) return;
            
            $.ajax({
                url: '{% url "check-yaml-name" %}',
                data: { 'yaml_name': yamlName },
                method: 'GET',
                success: function(response) {
                    if (response.exists) {
                        $('#name-error').show();
                        submitButton.disabled = true;
                        templateNameInput.classList.add('is-invalid');
                    } else {
                        $('#name-error').hide();
                        submitButton.disabled = false;
                        templateNameInput.classList.remove('is-invalid');
                    }
                },
                error: function(xhr, status, error) {
                    console.error("Error checking YAML name:", error);
                }
            });
        }

        // Add input event listener with debounce
        templateNameInput.addEventListener('input', function() {
            clearTimeout(nameValidationTimeout);
            nameValidationTimeout = setTimeout(() => {
                validateYamlName(this.value.trim());
            }, 300);
        });

        // Modify your existing form submission
        $('.form').on('submit', function (event) {
            event.preventDefault();

            // Validate form
            if (!$('#templatename').val()) {
                alert('Please enter a template name');
                return false;
            }

            if ($('#name-error').is(':visible')) {
                alert('Please choose a unique YAML name');
                return false;
            }

            if (!$('#description').val()) {
                alert('Please enter a description');
                return false;
            }

            // Your existing form submission code...
            var selectedModels = [];
            table.$('input[type="checkbox"]:checked').each(function () {
                var row = $(this).closest('tr');
                var modelData = {
                    model_id: row.find('td:eq(1)').text().trim(),
                    model_name: row.find('td:eq(2)').text().trim(),
                    mapid: row.find('td:eq(3)').text().trim(),
                    map_tg263_primary_name: row.find('td:eq(4)').text().trim(),
                    model_config: row.find('td:eq(5)').text().trim(),
                    model_trainer_name: row.find('td:eq(6)').text().trim(),
                    model_postprocess: row.find('td:eq(7)').text().trim()
                };
                selectedModels.push(modelData);
            });

            var formData = {
                template_name: $('#templatename').val(),
                description: $('#description').val(),
                selected_models: selectedModels
            };

            // Final validation before submission
            validateYamlName($('#templatename').val().trim());
            
            if (!$('#name-error').is(':visible')) {
                $.ajax({
                    type: 'POST',
                    url: '{% url "create-yml" %}',
                    data: JSON.stringify(formData),
                    contentType: 'application/json; charset=utf-8',
                    headers: {
                        'X-CSRFToken': $('input[name="csrfmiddlewaretoken"]').val()
                    },
                    success: function (response) {
                        if (response.status === 'success' && response.redirect_url) {
                            window.location.href = response.redirect_url;
                        }
                    },
                    error: function (xhr, status, error) {
                        console.error("Error:", xhr.responseText);
                    }
                });
            }
        });

        // Your existing DataTable initialization...
    });
</script>

<style>
    .is-invalid {
        border-color: #dc3545;
        padding-right: calc(1.5em + .75rem);
        background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 12 12' width='12' height='12' fill='none' stroke='%23dc3545'%3e%3ccircle cx='6' cy='6' r='4.5'/%3e%3cpath stroke-linejoin='round' d='M5.8 3.6h.4L6 6.5z'/%3e%3ccircle cx='6' cy='8.2' r='.6' fill='%23dc3545' stroke='none'/%3e%3c/svg%3e");
        background-repeat: no-repeat;
        background-position: right calc(.375em + .1875rem) center;
        background-size: calc(.75em + .375rem) calc(.75em + .375rem);
    }

    .alert {
        padding: .75rem 1.25rem;
        margin-bottom: 1rem;
        border: 1px solid transparent;
        border-radius: .25rem;
    }

    .alert-danger {
        color: #721c24;
        background-color: #f8d7da;
        border-color: #f5c6cb;
    }
</style>
{% endblock content %}